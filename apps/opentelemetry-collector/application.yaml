# yaml-language-server: $schema=https://github.com/adobe-platform/kubernetes-json-schema/raw/refs/heads/master/master-standalone/application-argoproj-v1alpha1.json
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: opentelemetry-collector
  namespace: argocd
spec:
  project: homelab
  sources:
    # https://artifacthub.io/packages/helm/opentelemetry-helm/opentelemetry-collector
    - repoURL: https://open-telemetry.github.io/opentelemetry-helm-charts
      chart: opentelemetry-collector
      targetRevision: 0.143.1
      helm:
        releaseName: opentelemetry-collector
        valuesObject:
          mode: deployment
          image:
            repository: otel/opentelemetry-collector-contrib
          presets:
            hostMetrics:
              enabled: true
            kubernetesEvents:
              enabled: true
            clusterMetrics:
              enabled: true
            logsCollection:
              enabled: true
              includeCollectorLogs: true
          config:
            processors:
              batch: {}
              resourcedetection:
                detectors: [env, system]
            exporters:
              otlphttp/loki:
                endpoint: http://loki-gateway.monitoring.svc.cluster.local:3100
              otlphttp/prometheus:
                endpoint: http://prometheus-server.monitoring.svc.cluster.local:9090
            service:
              pipelines:
                logs:
                  processors: [batch, resourcedetection]
                  exporters: [debug, otlphttp/loki]
                metrics:
                  processors: [batch, resourcedetection]
                  exporters: [debug, otlphttp/prometheus]
                  # processors:
                  #   # https://opentelemetry.io/blog/2026/log-deduplication-processor/
                  #   - logdedup:
                  #       interval: 1s
                  #     conditions:
                  #       - severity_number >= SEVERITY_NUMBER_ERROR
                  #       - attributes["log.type"] == "connection"
                  #     exclude_fields:
                  #       - attributes.request_id
                  #       - attributes.timestamp

  destination:
    name: in-cluster
    namespace: monitoring
  syncPolicy:
    automated:
      enabled: true
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
